<?xml version="1.0" encoding="UTF-8"?>
<context>
  <metadata>
    <story_key>story-session-persistence</story_key>
    <story_title>Session Persistence</story_title>
    <generated>2025-11-11</generated>
    <status>ready-for-dev</status>
    <project>hl7-capture</project>
    <project_level>0</project_level>
  </metadata>
  <story>
    <as_a>product user</as_a>
    <i_want>the application to persist captured HL7 sessions for a configurable retention period</i_want>
    <so_that>I can retain and inspect past sessions across restarts and avoid losing important diagnostic data</so_that>
  </story>
  <acceptance_criteria>
    <criterion id="1">
      <title>Persistence Location and Format</title>
      <requirement>Sessions stored under {project-root}/docs/sessions/ as individual JSON files with version metadata</requirement>
      <test_approach>Verify file exists at expected path, validate JSON schema after save, check version metadata present</test_approach>
    </criterion>
    <criterion id="2">
      <title>Retention Policy Configuration</title>
      <requirement>Configurable retention (1-365 days, default 30) with persistedUntil unix-ms timestamp</requirement>
      <test_approach>Set retentionDays, verify persistedUntil = now + (retentionDays * 86400000), verify config persisted</test_approach>
    </criterion>
    <criterion id="3">
      <title>Atomic Writes and Crash-Safety</title>
      <requirement>Atomic writes (temp + rename), crash-safe recovery on startup, corrupt files skipped</requirement>
      <test_approach>Simulate crash mid-write, verify recovery, test corrupt JSON handling</test_approach>
    </criterion>
    <criterion id="4">
      <title>Async Persistence (Non-Blocking)</title>
      <requirement>Persistence off main capture loop, session completion IPC sent immediately</requirement>
      <test_approach>Measure main loop latency with and without persistence, verify IPC timing independent of I/O</test_approach>
    </criterion>
    <criterion id="5">
      <title>Config Integration</title>
      <requirement>UI settings expose enablePersistence toggle and retentionDays spinner (1-365 range)</requirement>
      <test_approach>Verify settings render, toggle enable/disable, spinner range enforcement, config applied</test_approach>
    </criterion>
  </acceptance_criteria>
  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec.md</path>
        <title>Technical Specification - Session Persistence</title>
        <section>Session Persistence and Submission</section>
      </doc>
      <doc>
        <path>docs/tech-spec.md</path>
        <title>HL7Session Data Structure</title>
        <section>4.1 Main Process Architecture</section>
      </doc>
    </docs>
    <code>
      <item>
        <path>src/main/hl7-capture.ts</path>
        <kind>class</kind>
        <symbol>HL7CaptureManager</symbol>
        <reason>Main capture manager where session completion event fires</reason>
      </item>
      <item>
        <path>src/common/types.ts</path>
        <kind>interface</kind>
        <symbol>HL7Session</symbol>
        <reason>Core session data structure including persistence fields</reason>
      </item>
      <item>
        <path>src/preload/index.ts</path>
        <kind>module</kind>
        <symbol>window.electron IPC bridge</symbol>
        <reason>Add new IPC handlers for session persistence</reason>
      </item>
    </code>
    <interfaces>
      <interface>
        <name>SessionStore API</name>
        <kind>class interface</kind>
        <signature>saveSession(session: HL7Session, retentionDays: number): Promise void; loadAllSessions(sessionsDir: string): Promise HL7Session[]; deleteSession(sessionId: string, sessionsDir: string): Promise void</signature>
        <path>src/main/session-store.ts</path>
      </interface>
    </interfaces>
    <constraints>
      <constraint>Atomic writes using temp file then fs.renameSync()</constraint>
      <constraint>Async persistence off main capture loop</constraint>
      <constraint>TypeScript strict mode, Promise-based async only</constraint>
      <constraint>No external DB libraries - fs module only</constraint>
      <constraint>Schema versioning for future migrations</constraint>
    </constraints>
  </artifacts>
  <tests>
    <standards>Unit tests in tests/unit/ use Jest with mocked filesystem. Integration tests use actual temp filesystem. Target 80%+ coverage.</standards>
    <locations>tests/unit/session-store.test.ts, tests/integration/session-persistence.test.ts</locations>
    <ideas>
      <test ac_id="1">Test saveSession creates file with valid JSON at correct path</test>
      <test ac_id="2">Test persistedUntil timestamp calculated correctly</test>
      <test ac_id="3">Test atomic write and corrupt file recovery on startup</test>
      <test ac_id="4">Test IPC update sent before persistence completes</test>
      <test ac_id="5">Test UI settings render and config changes applied without restart</test>
      <integration>Simulate capture, persist, app restart, verify session reloaded</integration>
    </ideas>
  </tests>
  <implementation_summary>
    <phases>
      <phase n="1" hours="2">Core persistence layer (session-store.ts)</phase>
      <phase n="2" hours="1.5">HL7CaptureManager integration</phase>
      <phase n="3" hours="1">Configuration and UI wiring</phase>
      <phase n="4" hours="0.5">Error handling and robustness</phase>
      <phase n="5" hours="2.5">Unit and integration tests</phase>
      <phase n="6" hours="0.5">Documentation</phase>
    </phases>
    <total_effort_hours>8</total_effort_hours>
  </implementation_summary>
</context>
